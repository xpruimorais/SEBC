# Cloudera Manager Upgrade

## Backups

Checked the content of `db.properties`:
```
[root@node01 ~]# cat /etc/cloudera-scm-server/db.properties
# Auto-generated by scm_prepare_database.sh on Tue Oct 16 08:07:29 UTC 2018
#
# For information describing how to configure the Cloudera Manager Server
# to connect to databases, see the "Cloudera Manager Installation Guide."
#
com.cloudera.cmf.db.type=mysql
com.cloudera.cmf.db.host=node01.xpandit.com
com.cloudera.cmf.db.name=scm
com.cloudera.cmf.db.user=scm
com.cloudera.cmf.db.setupType=EXTERNAL
com.cloudera.cmf.db.password=scm_password
```

Backed up Cloudera Manager Agent and Repositories:
```
[root@node01 ~]# export CM_BACKUP_DIR="`date +%F`-CM5.13"
[root@node01 ~]# mkdir -p $CM_BACKUP_DIR
[root@node01 ~]# sudo -E tar -cf $CM_BACKUP_DIR/cloudera-scm-agent.tar --exclude=*.sock /etc/cloudera-scm-agent /etc/default/cloudera-scm-agent /var/run/cloudera-scm-agent /var/lib/cloudera-scm-agent
tar: Removing leading `/' from member names
[root@node01 ~]# sudo -E tar -cf $CM_BACKUP_DIR/repository.tar /etc/yum.repos.d
tar: Removing leading `/' from member names
```

Stopped Cloudera Manager Server:
```
[root@node01 ~]# systemctl stop cloudera-scm-server
```


Dumped databases:
```
[root@node01 ~]# mysqldump --databases scm --host=node01.xpandit.com --port=3306 -u scm -p > $HOME/scm-backup-`date +%F`-CM5.13.sql
[root@node01 ~]# mysqldump --databases metastore --host=node01.xpandit.com --port=3306 -u hive -p > $HOME/metastore-backup-`date +%F`-CM5.13.sql
[root@node01 ~]# mysqldump --databases hue --host=node01.xpandit.com --port=3306 -u hue -p > $HOME/hue-backup-`date +%F`-CM5.13.sql
[root@node01 ~]# mysqldump --databases rman --host=node01.xpandit.com --port=3306 -u rman -p > $HOME/rman-backup-`date +%F`-CM5.13.sql
[root@node01 ~]# mysqldump --databases oozie --host=node01.xpandit.com --port=3306 -u oozie -p > $HOME/oozie-backup-`date +%F`-CM5.13.sql
```

Backed up Cloudera Manager Server directory:
```
[root@node01 ~]# sudo -E tar -cf $CM_BACKUP_DIR/cloudera-scm-server.tar /etc/cloudera-scm-server /etc/default/cloudera-scm-server
tar: Removing leading `/' from member names
```

## Upgrade


Removed old Cloudera Manager repo:
```
[root@node01 ~]# rm /etc/yum.repos.d/cloudera*manager.repo*
```

Added new Cloudera Manager repo for version 5.14.x (latest) to:
```
[root@node01 ~]# cat /etc/yum.repos.d/cloudera-manager.repo
```


```
[root@node01 ~]# yum deplist cloudera-manager-agent
```

Stopped Cloudera Manager Server and Agent:
```
[root@node01 ~]# systemctl stop cloudera-scm-server
[root@node01 ~]# systemctl stop cloudera-scm-agent
```


Upgrade:
```
[root@node01 ~]# yum clean all
Loaded plugins: fastestmirror, langpacks
Cleaning repos: base cloudera-manager epel extras openlogic updates
Cleaning up everything
Cleaning up list of fastest mirrors
[root@node01 ~]# yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent
(...)
Resolving Dependencies
--> Running transaction check
---> Package cloudera-manager-agent.x86_64 0:5.13.3-1.cm5133.p0.6.el7 will be updated
---> Package cloudera-manager-agent.x86_64 0:5.14.4-1.cm5144.p0.3.el7 will be an update
cloudera-manager/filelists  | 128 kB  00:00:00
---> Package cloudera-manager-daemons.x86_64 0:5.13.3-1.cm5133.p0.6.el7 will be updated
---> Package cloudera-manager-daemons.x86_64 0:5.14.4-1.cm5144.p0.3.el7 will be an update
---> Package cloudera-manager-server.x86_64 0:5.13.3-1.cm5133.p0.6.el7 will be updated
---> Package cloudera-manager-server.x86_64 0:5.14.4-1.cm5144.p0.3.el7 will be an update
--> Finished Dependency Resolution
(...)
Updated:
  cloudera-manager-agent.x86_64 0:5.14.4-1.cm5144.p0.3.el7           cloudera-manager-daemons.x86_64 0:5.14.4-1.cm5144.p0.3.el7           cloudera-manager-server.x86_64 0:5.14.4-1.cm5144.p0.3.el7

Complete!
```

Checked installed packages:
```
[root@node01 ~]# rpm -qa 'cloudera-manager-*'
cloudera-manager-daemons-5.14.4-1.cm5144.p0.3.el7.x86_64
cloudera-manager-server-5.14.4-1.cm5144.p0.3.el7.x86_64
cloudera-manager-agent-5.14.4-1.cm5144.p0.3.el7.x86_64
```

Started both Cloudera Manager Agent and Server:
```
[root@node01 ~]# systemctl start cloudera-scm-agent
[root@node01 ~]# systemctl start cloudera-scm-server
```

After all started, upgraded Cloudera Manager Agents on the rest of the nodes via Cloudera Manager Upgrade Wizard in the browser.


# API Calls

### Latest API version
```
[root@node01 ~]# curl -u xpruimorais:cloudera -X GET 'http://rdsmsebc01.eastus.cloudapp.azure.com:7180/api/version'
v19
```

### CM version
```
[root@node01 ~]# curl -u xpruimorais:cloudera -X GET 'http://rdsmsebc01.eastus.cloudapp.azure.com:7180/api/v19/cm/version'
{
  "version" : "5.14.4",
  "buildUser" : "jenkins",
  "buildTimestamp" : "20180707-0445",
  "gitHash" : "0971e84bdceb60db9b96533f46451f40ed8cbdf9",
  "snapshot" : false
}
```

### CM users
```
[root@node01 ~]# curl -u xpruimorais:cloudera -X GET 'http://rdsmsebc01.eastus.cloudapp.azure.com:7180/api/v19/users'
{
  "items" : [ {
    "name" : "admin",
    "roles" : [ "ROLE_LIMITED" ]
  }, {
    "name" : "minotaur",
    "roles" : [ "ROLE_CONFIGURATOR" ]
  }, {
    "name" : "xpruimorais",
    "roles" : [ "ROLE_ADMIN" ]
  } ]
}
```

### Database server in use by CM
```
[root@node01 ~]# curl -u xpruimorais:cloudera -X GET 'http://rdsmsebc01.eastus.cloudapp.azure.com:7180/api/v19/cm/scmDbInfo'
{
  "scmDbType" : "MYSQL",
  "embeddedDbUsed" : false
}
```
